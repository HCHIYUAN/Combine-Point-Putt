<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>高爾夫球點數遊戲整合版</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root { color-scheme: light dark; }
        html, body { font-family: 'Inter', system-ui, -apple-system, Segoe UI, Roboto, 'Noto Sans TC', Arial, sans-serif; }
        .cell-input { width: 4.5rem; border-radius: 0.5rem; border: 1px solid #d1d5db; padding: 0.25rem; text-align: center; box-shadow: 0 1px 1px rgba(0,0,0,.02); outline: none; }
        .cell-input:focus { outline: none; box-shadow: 0 0 0 2px rgba(16,185,129,.35); }
        .cell-select { border-radius: 0.5rem; border: 1px solid #d1d5db; padding: 0.25rem; text-align: center; font-size: .875rem; box-shadow: 0 1px 1px rgba(0,0,0,.02); }
        .cell-select:focus { outline: none; box-shadow: 0 0 0 2px rgba(16,185,129,.35); }
        .soft-card { background: #fff; border-radius: 1rem; box-shadow: 0 10px 30px rgba(0,0,0,.06); }
        .score-cell { padding: 8px 6px; font-size: 0.875rem; line-height: 1.25rem; color: #4b5563; }
        .hidden { display: none; }
    </style>
</head>
<body class="bg-gray-100 p-4">
    <div class="flex justify-center p-4">
        <button id="toggleGolf" class="bg-emerald-500 hover:bg-emerald-600 text-white font-bold py-2 px-4 rounded mr-2">高爾夫球計分器</button>
        <button id="togglePoint" class="bg-gray-400 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded">金銀銅鐵計分器</button>
    </div>

    <!-- 高爾夫球計分器 -->
    <div id="golfCounter" class="container mx-auto max-w-5xl">
        <header class="soft-card p-6 sticky top-4 z-10">
            <h1 class="text-3xl font-bold text-center text-gray-800">高爾夫球計分器</h1>
            <p id="golfGameDescription" class="mt-2 text-center text-gray-600">依你提供的點數模式規則（Par/Bogey/Birdie/Eagle/加罰/Golden Ball）自動計分。</p>
            <section class="mt-6 grid gap-3 md:grid-cols-2">
                <div class="flex items-center justify-center gap-4 bg-gray-50 p-2 rounded-xl">
                    <label for="golfNumPlayers" class="font-medium text-gray-700">球員人數</label>
                    <select id="golfNumPlayers" class="cell-select w-20">
                        <option value="2">2</option>
                        <option value="3">3</option>
                        <option value="4" selected>4</option>
                    </select>
                    <label for="golfGoldenBallHole" class="font-medium text-gray-700">Golden Ball</label>
                    <select id="golfGoldenBallHole" class="cell-select w-28"></select>
                </div>
                <div class="flex items-center justify-center gap-3 bg-gray-50 p-2 rounded-xl">
                    <label for="golfCourseSelect" class="font-medium text-gray-700">球場</label>
                    <select id="golfCourseSelect" class="cell-select w-44">
                        <option value="guanyinshan" selected>觀音山球場</option>
                        <option value="nanyi">南一球場</option>
                        <option value="xinyi">信誼球場</option>
                        <option value="dagangshan">大崗山球場</option>
                        <option value="sinhwa">台南新化球場</option>
                        <option value="jianan">嘉南球場</option>
                        <option value="zhongluhe">棕梠湖球場</option>
                    </select>
                </div>
            </section>
            <section id="golfInOutDiv" class="mt-4 flex items-center justify-center gap-3 bg-gray-50 p-2 rounded-xl">
                <div class="flex items-center gap-2">
                    <label for="golfOutNineSelect" class="font-medium text-gray-700">1–9洞</label>
                    <select id="golfOutNineSelect" class="cell-select w-24">
                        <option value="out">OUT</option>
                        <option value="in">IN</option>
                    </select>
                </div>
                <div class="flex items-center gap-2">
                    <label for="golfInNineSelect" class="font-medium text-gray-700">10–18洞</label>
                    <select id="golfInNineSelect" class="cell-select w-24">
                        <option value="in">IN</option>
                        <option value="out">OUT</option>
                    </select>
                </div>
            </section>
            <section id="golfPlayerNames" class="mt-4 grid grid-cols-2 sm:grid-cols-4 gap-3">
                <label class="flex flex-col text-sm">
                    <span class="text-gray-700 mb-1">球員 1</span>
                    <input id="golfPlayer1Name" type="text" value="球員 A" class="cell-input">
                </label>
                <label class="flex flex-col text-sm">
                    <span class="text-gray-700 mb-1">球員 2</span>
                    <input id="golfPlayer2Name" type="text" value="球員 B" class="cell-input">
                </label>
                <label class="flex flex-col text-sm">
                    <span class="text-gray-700 mb-1">球員 3</span>
                    <input id="golfPlayer3Name" type="text" value="球員 C" class="cell-input">
                </label>
                <label class="flex flex-col text-sm">
                    <span class="text-gray-700 mb-1">球員 4</span>
                    <input id="golfPlayer4Name" type="text" value="球員 D" class="cell-input">
                </label>
            </section>
        </header>

        <section class="soft-card mt-6 overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50 text-xs font-semibold uppercase text-gray-600">
                    <tr>
                        <th class="px-3 py-3 text-left w-20">洞號</th>
                        <th id="golfParHeader" class="px-3 py-3 text-left w-20">標準桿</th>
                        <th id="golf-player-score-header-1" class="px-3 py-3 text-left">球員 A</th>
                        <th id="golf-player-score-header-2" class="px-3 py-3 text-left">球員 B</th>
                        <th id="golf-player-score-header-3" class="px-3 py-3 text-left">球員 C</th>
                        <th id="golf-player-score-header-4" class="px-3 py-3 text-left">球員 D</th>
                        <th id="golf-player-points-header-1" class="px-3 py-3 text-left">A 點數</th>
                        <th id="golf-player-points-header-2" class="px-3 py-3 text-left">B 點數</th>
                        <th id="golf-player-points-header-3" class="px-3 py-3 text-left">C 點數</th>
                        <th id="golf-player-points-header-4" class="px-3 py-3 text-left">D 點數</th>
                    </tr>
                </thead>
                <tbody id="golfScoreTableBody" class="bg-white divide-y divide-gray-100"></tbody>
            </table>
        </section>

        <section class="soft-card mt-6 overflow-x-auto">
            <h2 class="text-2xl font-bold text-center text-gray-800 py-4">最終結果</h2>
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50 text-xs font-semibold uppercase text-gray-600">
                    <tr>
                        <th class="px-3 py-3 text-left">球員</th>
                        <th class="px-3 py-3 text-left">總桿數</th>
                        <th class="px-3 py-3 text-left">總點數</th>
                        <th class="px-3 py-3 text-left">排名</th>
                    </tr>
                </thead>
                <tbody id="golfTotalTableBody" class="bg-white divide-y divide-gray-100"></tbody>
            </table>
        </section>
    </div>

    <!-- 金銀銅鐵計分器 -->
    <div id="pointCounter" class="container mx-auto max-w-4xl p-4 hidden">
        <div class="bg-white rounded-3xl shadow-xl p-8 w-full border border-gray-200">
            <h1 class="text-3xl font-bold text-center text-gray-800 mb-6">金銀銅鐵計分器</h1>
            <div class="bg-gray-50 p-6 rounded-2xl mb-6 border border-gray-200">
                <h2 class="text-xl font-semibold text-gray-700 mb-4">遊戲設定</h2>
                <div id="pointPlayerNameInputs" class="grid grid-cols-2 md:grid-cols-4 gap-4"></div>
            </div>
            <div id="pointSettingsSection" class="bg-gray-50 p-6 rounded-2xl mb-6 border border-gray-200">
                <h2 class="text-xl font-semibold text-gray-700 mb-4">分數設定</h2>
                <div class="grid grid-cols-2 md:grid-cols-5 gap-4">
                    <div class="flex flex-col">
                        <label for="point-cut" class="text-sm font-medium text-gray-600">切</label>
                        <input type="number" id="point-cut" value="150" min="10" max="500" class="mt-1 px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm text-sm text-center">
                    </div>
                    <div class="flex flex-col">
                        <label for="point-gold" class="text-sm font-medium text-gray-600">金</label>
                        <input type="number" id="point-gold" value="100" min="10" max="500" class="mt-1 px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm text-sm text-center">
                    </div>
                    <div class="flex flex-col">
                        <label for="point-silver" class="text-sm font-medium text-gray-600">銀</label>
                        <input type="number" id="point-silver" value="50" min="10" max="500" class="mt-1 px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm text-sm text-center">
                    </div>
                    <div class="flex flex-col">
                        <label for="point-bronze" class="text-sm font-medium text-gray-600">銅</label>
                        <input type="number" id="point-bronze" value="30" min="10" max="500" class="mt-1 px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm text-sm text-center">
                    </div>
                    <div class="flex flex-col">
                        <label for="point-iron" class="text-sm font-medium text-gray-600">鐵</label>
                        <input type="number" id="point-iron" value="20" min="10" max="500" class="mt-1 px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm text-sm text-center">
                    </div>
                </div>
            </div>
            <div id="pointGameInterface" class="bg-gray-50 p-6 rounded-2xl border border-gray-200">
                <h2 class="text-xl font-semibold text-gray-700 mb-4">計分板</h2>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">洞數</th>
                                <th id="point-player-header-0" class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">玩家1</th>
                                <th id="point-player-header-1" class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">玩家2</th>
                                <th id="point-player-header-2" class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">玩家3</th>
                                <th id="point-player-header-3" class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">玩家4</th>
                            </tr>
                        </thead>
                        <tbody id="pointScoreTableBody" class="bg-white divide-y divide-gray-200"></tbody>
                        <tfoot class="bg-gray-100">
                            <tr>
                                <td class="px-3 py-3 text-left text-sm font-medium text-gray-900">總計</td>
                                <td id="point-total-score-0" class="px-3 py-3 text-left text-sm font-bold text-gray-900">0</td>
                                <td id="point-total-score-1" class="px-3 py-3 text-left text-sm font-bold text-gray-900">0</td>
                                <td id="point-total-score-2" class="px-3 py-3 text-left text-sm font-bold text-gray-900">0</td>
                                <td id="point-total-score-3" class="px-3 py-3 text-left text-sm font-bold text-gray-900">0</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- 整合後的 JavaScript -->
    <script>
        // 高爾夫球計分器
        const golfApp = (function () {
            const qs = (sel, el = document) => el.querySelector(sel);
            const qsa = (sel, el = document) => Array.from(el.querySelectorAll(sel));
            const clamp = (n, min, max) => Math.min(Math.max(n, min), max);
            const toInt = (v) => (v === '' || v === null || Number.isNaN(Number(v)) ? null : parseInt(v, 10));
            const debounce = (fn, wait = 120) => { let t; return (...args) => { clearTimeout(t); t = setTimeout(() => fn(...args), wait); }; };

            const el = {
                numPlayers: qs('#golfNumPlayers'),
                goldenBallHole: qs('#golfGoldenBallHole'),
                courseSelect: qs('#golfCourseSelect'),
                outNine: qs('#golfOutNineSelect'),
                inNine: qs('#golfInNineSelect'),
                parHeader: qs('#golfParHeader'),
                scoreBody: qs('#golfScoreTableBody'),
                totalBody: qs('#golfTotalTableBody'),
                playerScoreHeaders: [1,2,3,4].map(i => qs(`#golf-player-score-header-${i}`)),
                playerPointHeaders: [1,2,3,4].map(i => qs(`#golf-player-points-header-${i}`)),
                playerNameInputs: [1,2,3,4].map(i => qs(`#golfPlayer${i}Name`)),
                gameDesc: qs('#golfGameDescription'),
            };

            const COURSE_PAR = {
                guanyinshan: { out: [5,4,4,5,4,4,4,3,3], in: [4,4,3,4,5,4,3,5,4] },
                nanyi: { out: [5,4,3,4,4,4,4,3,5], in: [4,5,4,3,4,3,4,5,4] },
                xinyi: { out: [4,4,3,5,4,3,4,5,4], in: [4,4,4,3,4,5,4,3,5] },
                dagangshan: { out: [4,5,3,4,5,4,4,3,4], in: [4,4,4,3,5,4,3,5,4] },
                sinhwa: { out: [5,4,3,4,3,5,4,4,4], in: [4,4,4,3,4,5,4,3,5] },
                jianan: { out: [4,5,4,4,3,4,4,3,5], in: [4,4,3,4,3,5,4,5,4] },
                zhongluhe: { out: [5,4,3,4,4,3,4,5,4], in: [4,4,4,5,3,4,4,3,5] },
            };

            const DEFAULTS = { numPlayers: 4, goldenBall: 18, course: 'guanyinshan', outNine: 'out', inNine: 'in', names: ['球員 A','球員 B','球員 C','球員 D'] };
            const state = { ...DEFAULTS, names: [...DEFAULTS.names], par: [] };
            const STORAGE_KEY = 'golf-scorecard-v2';

            function loadState() { try { const raw = localStorage.getItem(STORAGE_KEY); if (!raw) return; const saved = JSON.parse(raw); Object.assign(state, saved, { names: saved.names || state.names }); } catch {} }
            const saveState = debounce(() => { localStorage.setItem(STORAGE_KEY, JSON.stringify({ numPlayers: state.numPlayers, goldenBall: state.goldenBall, course: state.course, outNine: state.outNine, inNine: state.inNine, names: state.names })); }, 300);

            function resolveParAndHoleNos() {
                const out = COURSE_PAR[state.course].out;
                const inn = COURSE_PAR[state.course].in;
                const par = [];
                const holes = [];

                if (state.outNine === 'out') { par.push(...out); holes.push(...[1,2,3,4,5,6,7,8,9]); }
                else { par.push(...inn); holes.push(...[10,11,12,13,14,15,16,17,18]); }

                if (state.inNine === 'in') { par.push(...inn); holes.push(...[10,11,12,13,14,15,16,17,18]); }
                else { par.push(...out); holes.push(...[1,2,3,4,5,6,7,8,9]); }
                
                return { par, holes };
            }

            function updateHeaders() {
                const numVisiblePlayers = state.numPlayers;
                for (let i = 0; i < 4; i++) {
                    const name = state.names[i] || `球員 ${i+1}`;
                    el.playerScoreHeaders[i].textContent = name;
                    el.playerPointHeaders[i].textContent = `${name} 點數`;
                    const show = i < numVisiblePlayers;
                    el.playerScoreHeaders[i].classList.toggle('hidden', !show);
                    el.playerPointHeaders[i].classList.toggle('hidden', !show);
                    const wrap = el.playerNameInputs[i].closest('label');
                    wrap.classList.toggle('hidden', !show);
                }
            }

            function renderGoldenBallOptions() { el.goldenBallHole.innerHTML = ''; for (let i = 1; i <= 18; i++) { const opt = document.createElement('option'); opt.value = String(i); opt.textContent = `第 ${i} 洞`; if (i === state.goldenBall) opt.selected = true; el.goldenBallHole.appendChild(opt); } }

            function renderGolfTable() {
                el.scoreBody.innerHTML = '';
                const { par, holes } = resolveParAndHoleNos();
                state.par = par;
                for (let r = 0; r < 18; r++) {
                    const holeNo = holes[r];
                    const parValue = par[r];
                    const isGolden = holeNo === state.goldenBall;
                    const tr = document.createElement('tr');
                    tr.dataset.hole = String(holeNo);

                    const holeCell = `<td class="px-3 py-2 whitespace-nowrap text-sm font-semibold ${isGolden ? 'text-yellow-600' : 'text-gray-900'}">${r+1} (${holeNo})${isGolden ? ' ⭐' : ''}</td>`;
                    const parCell = `<td class="px-3 py-2 text-sm text-gray-700"><input type="number" min="3" max="5" value="${parValue}" class="cell-input par-input" data-hole="${holeNo}"></td>`;
                    
                    let inputCells = '';
                    const maxPlayers = state.numPlayers;
                    for (let p = 1; p <= 4; p++) {
                        const hidden = p > maxPlayers ? 'hidden' : '';
                        inputCells += `<td class="px-3 py-2 text-sm ${hidden}"><input type="number" min="1" max="20" class="cell-input golf-player-score" data-hole="${holeNo}" data-player="${p}"></td>`;
                    }
                    
                    let pointCells = '';
                    for (let p = 1; p <= 4; p++) {
                        const hidden = p > maxPlayers ? 'hidden' : '';
                        pointCells += `<td class="px-3 py-2 text-sm text-center ${hidden} ${isGolden ? 'bg-yellow-50' : ''}"><span id="golf-points-h${holeNo}-p${p}" class="font-semibold text-gray-600">-</span></td>`;
                    }
                    
                    tr.innerHTML = holeCell + parCell + inputCells + pointCells;
                    el.scoreBody.appendChild(tr);
                }
            }

            function renderGolfTotals(rows) {
                const sortedRows = [...rows].sort((a,b) => b.points - a.points || a.strokes - b.strokes);
                el.totalBody.innerHTML = '';
                sortedRows.forEach((r, i) => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td class="px-3 py-2 text-sm text-gray-900">${r.name}</td>
                        <td class="px-3 py-2 text-sm text-gray-700">${r.strokes}</td>
                        <td class="px-3 py-2 text-sm ${r.points > 0 ? 'text-green-600' : r.points < 0 ? 'text-red-600' : 'text-gray-700'}">${r.points}</td>
                        <td class="px-3 py-2 text-sm">${i+1}</td>
                    `;
                    el.totalBody.appendChild(tr);
                });
            }

            function calcPointsMode() {
                const N = state.numPlayers;
                const totals = Array(N).fill(0);
                const strokes = Array(N).fill(0);
                const { par, holes } = resolveParAndHoleNos();
                
                for (let r = 0; r < 18; r++) {
                    const holeNo = holes[r];
                    const parValue = par[r];
                    const scores = Array.from({length:N}, (_,i)=>{
                        const input = qs(`.golf-player-score[data-hole="${holeNo}"][data-player="${i+1}"]`);
                        return toInt(input && input.value);
                    });
                    
                    let validScoresExist = false;
                    for (let i=0; i<N; i++) {
                        if (scores[i] !== null) {
                            strokes[i] += scores[i];
                            validScoresExist = true;
                        }
                    }

                    if (!validScoresExist) {
                        for (let p = 0; p < N; p++) {
                            const span = qs(`#golf-points-h${holeNo}-p${p+1}`);
                            if (span) span.textContent = '-';
                        }
                        continue;
                    }

                    const holePts = Array(N).fill(0);
                    const isGolden = holeNo === state.goldenBall;

                    for (let i = 0; i < N; i++) {
                        if (scores[i] === null) continue;
                        for (let j = i + 1; j < N; j++) {
                            if (scores[j] === null) continue;
                            let points = calcPairPointsByRules(scores[i], scores[j], parValue);
                            if (isGolden) {
                                if (scores[i] < scores[j]) { points += 1; }
                                else if (scores[j] < scores[i]) { points -= 1; }
                            }
                            holePts[i] += points;
                            holePts[j] -= points;
                        }
                    }
                    for (let i=0; i<N; i++) {
                        const span = qs(`#golf-points-h${holeNo}-p${i+1}`);
                        const val = holePts[i] || 0;
                        if (span) {
                            span.textContent = val;
                            span.className = `font-semibold ${val>0?'text-green-600':val<0?'text-red-600':'text-gray-600'}`;
                        }
                        totals[i] += val;
                    }
                }
                const rows = [...Array(N)].map((_,i)=>({ name: state.names[i], strokes: strokes[i], points: totals[i] }));
                renderGolfTotals(rows);
            }
            
            function calcPairPointsByRules(a, b, par) {
                if (a === null || b === null) return 0;
                const aRel = a - par;
                const bRel = b - par;
            
                let points = 0;
                if (aRel === 0 && bRel > 0) { points = 2; }
                if (aRel > 0 && bRel === 0) { points = -2; }
                if (aRel > 0 && bRel > 0) {
                    if (a < b) { points = 1; }
                    else if (b < a) { points = -1; }
                }
                if (aRel < 0 && bRel >= 0) {
                    if (aRel === -1) { points = (bRel === 0) ? 1 : 3; }
                    else if (aRel <= -2) { points = (bRel === 0) ? 3 : 5; }
                }
                if (bRel < 0 && aRel >= 0) {
                    if (bRel === -1) { points = -((aRel === 0) ? 1 : 3); }
                    else if (bRel <= -2) { points = -((aRel === 0) ? 3 : 5); }
                }
                if (aRel < 0 && bRel < 0) {
                    if (a < b) { points = (aRel <= -2) ? 3 : 1; }
                    else if (b < a) { points = -((bRel <= -2) ? 3 : 1); }
                }

                if ((par === 4 || par === 5) && a >= par * 2 && a > b) { points -= 1; }
                if ((par === 4 || par === 5) && b >= par * 2 && b > a) { points += 1; }

                return points;
            }

            function recalcGolf() {
                calcPointsMode();
                saveState();
            }
            const recalcGolfDebounced = debounce(recalcGolf, 80);

            function bindEvents() {
                el.numPlayers.addEventListener('change', (e) => {
                    state.numPlayers = clamp(parseInt(e.target.value,10)||4, 2, 4);
                    updateHeaders();
                    renderGolfTable();
                    recalcGolf();
                });
                el.playerNameInputs.forEach((inp, idx) => inp.addEventListener('input', () => {
                    state.names[idx] = inp.value.trim() || `球員 ${idx+1}`;
                    updateHeaders();
                    recalcGolfDebounced();
                }));
                [el.courseSelect, el.outNine, el.inNine].forEach(sel => sel.addEventListener('change', () => {
                    state.course = el.courseSelect.value;
                    state.outNine = el.outNine.value;
                    state.inNine = el.inNine.value;
                    renderGolfTable();
                    recalcGolf();
                }));
                el.goldenBallHole.addEventListener('change', (e) => {
                    state.goldenBall = clamp(parseInt(e.target.value,10)||18, 1, 18);
                    renderGolfTable();
                    recalcGolf();
                });
                el.scoreBody.addEventListener('input', (e) => {
                    const t = e.target;
                    if (t.matches('.golf-player-score')) {
                        const v = clamp(toInt(t.value), 1, 20);
                        t.value = v;
                        recalcGolfDebounced();
                    } else if (t.matches('.par-input')) {
                        const v = clamp(toInt(t.value), 3, 5);
                        t.value = v;
                        recalcGolfDebounced();
                    }
                });
            }

            function init() {
                loadState();
                el.numPlayers.value = String(state.numPlayers);
                el.courseSelect.value = state.course;
                el.outNine.value = state.outNine;
                el.inNine.value = state.inNine;
                el.playerNameInputs.forEach((inp,i)=> inp.value = state.names[i]);
                renderGoldenBallOptions();
                el.goldenBallHole.value = String(state.goldenBall);
                updateHeaders();
                renderGolfTable();
                bindEvents();
                recalcGolf();
            }

            return { init, recalcGolf };
        })();


        // 金銀銅鐵計分器
        const pointApp = (function() {
            const playerCount = 4;
            const totalHoles = 18;
            let pointValues = {
                '切': 150, '金': 100, '銀': 50, '銅': 30, '鐵': 20, '無': 0, '空白': 0
            };
            let playerScores = Array.from({ length: totalHoles }, () => Array(playerCount).fill('空白'));
            let playerNames = ['玩家1', '玩家2', '玩家3', '玩家4'];
            const resultTypes = ['空白', '切', '金', '銀', '銅', '鐵', '無'];
            const resultTypeLabels = ['(空白)', '切', '金', '銀', '銅', '鐵', '無'];
            
            const pointInputs = document.querySelectorAll('#pointSettingsSection input[type="number"]');
            const pointScoreTableBody = document.getElementById('pointScoreTableBody');
            const pointPlayerNameInputsContainer = document.getElementById('pointPlayerNameInputs');
            const pointTotalScoreEls = [0, 1, 2, 3].map(i => document.getElementById(`point-total-score-${i}`));

            function renderPointPlayerNameInputs() {
                pointPlayerNameInputsContainer.innerHTML = '';
                for (let i = 0; i < playerCount; i++) {
                    pointPlayerNameInputsContainer.innerHTML += `
                        <div class="flex flex-col">
                            <label for="point-player-name-${i}" class="text-sm font-medium text-gray-600">玩家 ${i + 1} 姓名</label>
                            <input type="text" id="point-player-name-${i}" value="${playerNames[i]}" class="mt-1 px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm text-sm">
                        </div>
                    `;
                }
                document.querySelectorAll('#pointPlayerNameInputs input').forEach((input, i) => {
                    input.addEventListener('input', (e) => {
                        playerNames[i] = e.target.value;
                        updatePointHeaders();
                    });
                });
            }

            function updatePointHeaders() {
                for (let i = 0; i < playerCount; i++) {
                    const header = document.getElementById(`point-player-header-${i}`);
                    if (header) header.textContent = playerNames[i];
                }
            }

            function renderPointScoreTable() {
                pointScoreTableBody.innerHTML = '';
                for (let hole = 1; hole <= totalHoles; hole++) {
                    const tr = document.createElement('tr');
                    tr.className = 'hover:bg-gray-50';
                    const holeCell = `<td class="px-3 py-2 whitespace-nowrap text-sm font-medium text-gray-900">第 ${hole} 洞</td>`;
                    tr.innerHTML += holeCell;

                    for (let i = 0; i < playerCount; i++) {
                        const scoreCell = document.createElement('td');
                        scoreCell.className = `px-3 py-2 whitespace-nowrap text-sm`;
                        const selectHtml = `<select class="w-full inline-block px-1 py-1 bg-white border border-gray-300 rounded-md shadow-sm text-sm point-player-score-select" data-hole="${hole}" data-player="${i}">
                                                ${resultTypes.map((type, idx) => `<option value="${type}" ${playerScores[hole - 1][i] === type ? 'selected' : ''}>${resultTypeLabels[idx]}</option>`).join('')}
                                            </select>`;
                        const pointsSpan = `<span id="point-points-h${hole}-p${i}" class="block mt-1 font-bold text-gray-500">0</span>`;
                        scoreCell.innerHTML = selectHtml + pointsSpan;
                        tr.appendChild(scoreCell);
                    }
                    pointScoreTableBody.appendChild(tr);
                }
                bindPointEvents();
            }

            const debounce = (fn, wait = 120) => { let t; return (...args) => { clearTimeout(t); t = setTimeout(() => fn(...args), wait); }; };

            function updatePointScoreboard() {
                const playerTotals = Array(playerCount).fill(0);
                
                for (let hole = 1; hole <= totalHoles; hole++) {
                    const holePoints = calculatePointHoleScores(hole);
                    
                    holePoints.forEach((point, index) => {
                        playerTotals[index] += point;
                        const pointSpan = document.getElementById(`point-points-h${hole}-p${index}`);
                        if (pointSpan) {
                             pointSpan.textContent = point;
                             pointSpan.className = `block mt-1 font-bold ${point > 0 ? 'text-green-600' : point < 0 ? 'text-red-600' : 'text-gray-500'}`;
                        }
                    });
                }

                for (let i = 0; i < playerCount; i++) {
                    if (pointTotalScoreEls[i]) {
                        pointTotalScoreEls[i].textContent = playerTotals[i];
                    }
                }
            }
            
            function calculatePointHoleScores(hole) {
                const points = Array(playerCount).fill(0);
                const holeResults = playerScores[hole - 1];

                const winners = [];
                for (let i = 0; i < playerCount; i++) {
                    const scoreType = holeResults[i];
                    if (scoreType !== '無' && scoreType !== '空白') {
                        winners.push({ id: i, value: pointValues[scoreType] });
                    }
                }

                // 計算每個玩家的得分/付分
                for (let i = 0; i < playerCount; i++) {
                    const myScoreType = holeResults[i];
                    const myScoreValue = pointValues[myScoreType];
                    
                    if (myScoreType === '空白') continue;

                    let totalPointsChange = 0;
                    
                    // 1. 計算「獲得」的點數：自己有得分，就從所有非空白的玩家那邊收取
                    if (myScoreType !== '無') {
                        const nonBlankPlayers = holeResults.filter(score => score !== '空白').length;
                        // 點數 = 自己的分數 * (其他有參與的玩家數)
                        totalPointsChange += myScoreValue * (nonBlankPlayers - 1);
                    }
                    
                    // 2. 計算「支付」的點數：付給所有有得分的玩家
                    for (const winner of winners) {
                        if (winner.id !== i) { // 不付給自己
                            totalPointsChange -= winner.value;
                        }
                    }

                    points[i] = totalPointsChange;
                }
                
                return points;
            }

            const updatePointScoreboardDebounced = debounce(updatePointScoreboard, 80);

            function bindPointEvents() {
                pointInputs.forEach(input => {
                    input.addEventListener('change', () => {
                        const type = input.id.split('-')[1];
                        switch (type) {
                            case 'cut': pointValues['切'] = parseInt(input.value); break;
                            case 'gold': pointValues['金'] = parseInt(input.value); break;
                            case 'silver': pointValues['銀'] = parseInt(input.value); break;
                            case 'bronze': pointValues['銅'] = parseInt(input.value); break;
                            case 'iron': pointValues['鐵'] = parseInt(input.value); break;
                        }
                        updatePointScoreboardDebounced();
                    });
                });
                
                document.querySelectorAll('.point-player-score-select').forEach(select => {
                    select.addEventListener('change', (e) => {
                        const h = parseInt(e.target.dataset.hole);
                        const p = parseInt(e.target.dataset.player);
                        playerScores[h - 1][p] = e.target.value;
                        updatePointScoreboardDebounced();
                    });
                });
            }

            function init() {
                renderPointPlayerNameInputs();
                renderPointScoreTable();
            }

            return { init, updatePointScoreboard };
        })();


        // 主控台，負責切換和初始化
        document.addEventListener('DOMContentLoaded', () => {
            const golfCounter = document.getElementById('golfCounter');
            const pointCounter = document.getElementById('pointCounter');
            const toggleGolfBtn = document.getElementById('toggleGolf');
            const togglePointBtn = document.getElementById('togglePoint');

            function showGolf() {
                golfCounter.classList.remove('hidden');
                pointCounter.classList.add('hidden');
                toggleGolfBtn.classList.add('bg-emerald-500');
                toggleGolfBtn.classList.remove('bg-gray-400');
                togglePointBtn.classList.add('bg-gray-400');
                togglePointBtn.classList.remove('bg-emerald-500');
                golfApp.recalcGolf();
            }

            function showPoint() {
                pointCounter.classList.remove('hidden');
                golfCounter.classList.add('hidden');
                togglePointBtn.classList.add('bg-emerald-500');
                togglePointBtn.classList.remove('bg-gray-400');
                toggleGolfBtn.classList.add('bg-gray-400');
                toggleGolfBtn.classList.remove('bg-emerald-500');
                pointApp.updatePointScoreboard();
            }

            toggleGolfBtn.addEventListener('click', showGolf);
            togglePointBtn.addEventListener('click', showPoint);

            golfApp.init();
            pointApp.init();
            showGolf();
        });
    </script>
</body>
</html>
